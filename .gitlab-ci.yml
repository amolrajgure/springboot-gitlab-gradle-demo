stages:
  - build
  - docker
  - test

variables:
  COMPOSE_PROJECT_NAME: chapter04
  DOCKER_BUILDKIT: "1"

# --------------------------------------------------
# 1️⃣ Build JARs using Gradle
# --------------------------------------------------
build-jars:
  stage: build
  image: eclipse-temurin:24-jdk
  script:
    - cd app
    - ./gradlew build
  artifacts:
    paths:
      - "**/build/libs/*.jar"

# --------------------------------------------------
# 2️⃣ Build Docker images (NO registry push)
# --------------------------------------------------
docker-build:
  stage: docker
  image: docker:26
  dependencies:
    - build-jars
  script:
    - cd app
    - docker compose build --parallel=false

# --------------------------------------------------
# 3️⃣ Start stack + run integration tests
# --------------------------------------------------
integration-test:
  stage: test
  image: docker:26
  dependencies:
    - docker-build
  script:
    - cd app

    # Start services
    - docker compose up -d

    # Wait a bit for services to be ready
    - sleep 20

    # Run end-to-end tests
    - chmod +x test-em-all.sh
    - ./test-em-all.sh

  after_script:
    # Always clean up
    - cd app
    - docker compose down -v
