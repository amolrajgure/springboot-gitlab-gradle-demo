stages:
  - build
  - docker

variables:
  COMPOSE_PROJECT_NAME: chapter04
  REGISTRY_IMAGE_PREFIX: $CI_REGISTRY_IMAGE
  TAG: $CI_COMMIT_SHORT_SHA

  
# --------------------------------------------------
# 1️⃣ Build JARs using Gradle (NO Docker here)
# --------------------------------------------------
build-jars:
  stage: build
  image: eclipse-temurin:24-jdk
  script:
    - cd app
    - ./gradlew build
  artifacts:
    paths:
      - "**/build/libs/*.jar"

# --------------------------------------------------
# 2️⃣ Build + Push Docker images using docker compose
# --------------------------------------------------
docker-build:
  stage: docker
  image: docker:26
  script:
    # Login to GitLab registry via host
    - echo "$CI_REGISTRY_PASSWORD" | docker login localhost:5050 -u "$CI_REGISTRY_USER" --password-stdin

    # Build images using docker-compose
    - cd app
    - docker compose build

    # Tag images for GitLab registry
    - docker tag app-product localhost:5050/root/springboot-gitlab-gradle-demo/product:latest
    - docker tag app-review localhost:5050/root/springboot-gitlab-gradle-demo/review:latest
    - docker tag app-recommendation localhost:5050/root/springboot-gitlab-gradle-demo/recommendation:latest
    - docker tag app-product-composite localhost:5050/root/springboot-gitlab-gradle-demo/product-composite:latest

    # Push images
    - docker push localhost:5050/root/springboot-gitlab-gradle-demo/product:latest
    - docker push localhost:5050/root/springboot-gitlab-gradle-demo/review:latest
    - docker push localhost:5050/root/springboot-gitlab-gradle-demo/recommendation:latest
    - docker push localhost:5050/root/springboot-gitlab-gradle-demo/product-composite:latest
