stages:
  - build
  - docker

variables:
  DOCKER_TLS_CERTDIR: ""
  COMPOSE_PROJECT_NAME: chapter04
  REGISTRY_IMAGE_PREFIX: $CI_REGISTRY_IMAGE
  TAG: $CI_COMMIT_SHORT_SHA

# üîë FIX: make artifact upload reachable from job containers
  CI_SERVER_URL: "http://host.docker.internal:8080"
  
# --------------------------------------------------
# 1Ô∏è‚É£ Build JARs using Gradle (NO Docker here)
# --------------------------------------------------
build-jars:
  stage: build
  image: eclipse-temurin:24-jdk
  script:
    - cd app
    - ./gradlew build
  artifacts:
    paths:
      - "**/build/libs/*.jar"

# --------------------------------------------------
# 2Ô∏è‚É£ Build + Push Docker images using docker compose
# --------------------------------------------------
docker-build:
  stage: docker
  image: docker:26
  services:
    - docker:26-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker compose build

    - docker tag chapter04-product-composite $REGISTRY_IMAGE_PREFIX/chapter04-product-composite:$TAG
    - docker tag chapter04-review $REGISTRY_IMAGE_PREFIX/chapter04-review:$TAG
    - docker tag chapter04-product $REGISTRY_IMAGE_PREFIX/chapter04-product:$TAG
    - docker tag chapter04-recommendation $REGISTRY_IMAGE_PREFIX/chapter04-recommendation:$TAG

    - docker push $REGISTRY_IMAGE_PREFIX/chapter04-product-composite:$TAG
    - docker push $REGISTRY_IMAGE_PREFIX/chapter04-review:$TAG
    - docker push $REGISTRY_IMAGE_PREFIX/chapter04-product:$TAG
    - docker push $REGISTRY_IMAGE_PREFIX/chapter04-recommendation:$TAG
