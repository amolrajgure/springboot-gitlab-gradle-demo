name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  COMPOSE_PROJECT_NAME: chapter04
  DOCKER_BUILDKIT: "1"

jobs:
  # --------------------------------------------------
  # 1️⃣ Build JARs using Gradle (REFERENCE ONLY)
  # --------------------------------------------------
#    build:
#    name: Build JARs
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 24
#        uses: actions/setup-java@v4
#        with:
#          distribution: temurin
#          java-version: 24
#
#      - name: Build with Gradle
#        working-directory: app
#        run: |
#          chmod +x gradlew
#          ./gradlew build
#
#      - name: Upload JAR artifacts
#        uses: actions/upload-artifact@v4
#        with:
#          name: jars
#          path: app/**/build/libs/*.jar

  # --------------------------------------------------
  # 2️⃣ Build Docker images (NO registry push)
  # --------------------------------------------------
  docker-build:
    runs-on: ubuntu-latest
    #needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 24

      - name: Build JARs (for Docker context)
        working-directory: app
        run: |
          chmod +x gradlew
          ./gradlew build

      - name: Build Docker images
        working-directory: app
        run: |
          docker compose build --parallel=false

  # --------------------------------------------------
  # 3️⃣ Start stack + run integration tests
  # --------------------------------------------------
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start services
        working-directory: app
        run: |
          docker compose up -d
          sleep 20

      - name: Run end-to-end tests
        working-directory: app
        run: |
          chmod +x test-em-all.sh
          HOST=product-composite ./test-em-all.sh

      - name: Cleanup
        if: always()
        working-directory: app
        run: |
          docker compose down -v

